<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pembuat API Key</title>
  <style>
    body{background:#ffe4ef;font-family:sans-serif}
    .card{width:360px;padding:25px;background:#fff;margin:80px auto;border-radius:14px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.1)}
    button{width:100%;padding:12px;border:none;margin-top:12px;background:#ff4081;color:#fff;border-radius:8px;cursor:pointer;font-size:15px}
    button:hover{background:#ff1f6d}
    input,textarea{width:100%;padding:12px;margin-top:12px;border-radius:8px;border:1px solid #ccc;font-size:14px;box-sizing:border-box}
    textarea{resize:none}
    .small{font-size:12px;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Buat API Key</h2>

    <!-- tombol generate -->
    <button id="btn-generate">Create API Key</button>

    <!-- tempat muncul API KEY -->
    <textarea id="apikey" rows="3" readonly>API Key akan muncul di sini...</textarea>
    <div class="small" id="msg"></div>

    <h3>Data User</h3>
    <input id="firstname" placeholder="First Name">
    <input id="lastname" placeholder="Last Name">
    <input id="email" placeholder="Email">

    <!-- tombol save -->
    <button id="btn-save">Save User</button>
  </div>

<script>
// =============================
// Helper message
// =============================
const msgEl = document.getElementById('msg');
function showMsg(t){
  msgEl.textContent = t;
  setTimeout(()=> msgEl.textContent = '', 5000);
}

// =============================
// API: Generate Key (NOT save DB)
// =============================
document.getElementById('btn-generate').addEventListener('click', async () => {
  document.getElementById('apikey').value = 'Generating...';

  const res = await fetch('/api/generate', { method: 'POST' });
  const data = await res.json();

  if (data.success) {
    // â† tampilkan API KEY saja
    document.getElementById('apikey').value = data.api_key;
    showMsg('API Key generated.');
  } else {
    document.getElementById('apikey').value = 'Generate failed';
  }
});

// =============================
// API: Save User (THIS saves to DB)
// =============================
document.getElementById('btn-save').addEventListener('click', async () => {
  const api_key = document.getElementById('apikey').value.trim();

  if (!api_key || api_key === "API Key akan muncul di sini..." || api_key === "Generating...") {
    return alert("Generate API Key dulu!");
  }

  const body = {
    first_name: document.getElementById('firstname').value,
    last_name: document.getElementById('lastname').value,
    email: document.getElementById('email').value,
    api_key: api_key   // <<< WAJIB DIKIRIM KE BACKEND
  };

  const res = await fetch('/api/user', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if (data.success) {
    alert("User berhasil disimpan ke database!");
    showMsg("User saved successfully!");
  } else {
    alert("Gagal menyimpan user: " + data.error);
  }
});
</script>

</body>
</html>
